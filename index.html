<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archive / Modern Vision</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&display=swap');

        :root {
            --bg: #0a0a0a;
            --primary: #ff007a;
            --text: #ffffff;
            --ios-blur: rgba(30, 30, 30, 0.4);
            --ios-accent: #007aff;
            --apple-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
        }

        /* 가로 스크롤 원천 차단 */
        * { box-sizing: border-box; }
        html, body { 
            margin: 0; padding: 0; width: 100%; 
            overflow-x: hidden; background: var(--bg); color: var(--text);
            font-family: var(--apple-font); letter-spacing: -0.02em;
        }

        .bg-text {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 25vw; font-weight: 900; color: rgba(255, 255, 255, 0.03);
            white-space: nowrap; z-index: -1; pointer-events: none; text-transform: uppercase;
            font-family: 'Syne'; width: 100vw; text-align: center; overflow: hidden;
        }

        nav {
            position: fixed; top: 0; width: 100%; padding: 40px 60px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; mix-blend-mode: difference;
        }
        nav .logo { font-weight: 800; letter-spacing: -1px; font-size: 1.4rem; cursor: pointer; font-family: 'Syne'; }
        nav ul { list-style: none; display: flex; gap: 40px; margin: 0; padding: 0; }
        nav li { 
            font-size: 0.7rem; font-weight: 400; text-transform: uppercase; 
            letter-spacing: 0.25em; cursor: pointer; opacity: 0.4; transition: 0.3s; 
        }
        nav li.active { opacity: 1; font-weight: 700; color: var(--primary); }

        .scroller { padding: 160px 5vw; min-height: 100vh; display: none; width: 100%; }
        .scroller.active { display: block; }

        /* 타이틀: 반응형 폰트 크기 적용 */
        #write-title { 
            font-size: clamp(3rem, 8vw, 7vw); 
            font-family: 'Syne'; line-height: 0.85; margin-bottom: 50px; 
            letter-spacing: -0.06em; font-weight: 800; 
        }

        .archive-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 40px; }
        .archive-item { cursor: pointer; transition: 0.4s ease; }
        .img-wrap { 
            width: 100%; aspect-ratio: 2/3; overflow: hidden; border-radius: 8px; 
            margin-bottom: 15px; background: #111; border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }
        .archive-item img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.1); transition: 0.6s cubic-bezier(0.2, 1, 0.3, 1); }
        .archive-item:hover img { filter: grayscale(0); transform: scale(1.04); }

        .imessage-container {
            max-width: 520px; margin: 0 auto; background: var(--ios-blur);
            backdrop-filter: blur(50px); border-radius: 35px; padding: 45px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }
        .ios-label { font-size: 0.65rem; color: #8e8e93; margin-bottom: 8px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.12em; }
        input, textarea { width: 100%; background: rgba(255,255,255,0.06); border: none; border-radius: 14px; padding: 18px; color: white; outline: none; font-size: 0.95rem; }
        .save-btn { width: 100%; padding: 20px; border-radius: 16px; background: #fff; color: #000; font-weight: 700; border: none; cursor: pointer; margin-top: 20px; transition: 0.3s; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); z-index: 2000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(35px);
        }
        .modal.active { display: flex; }
        .modal-content { 
            width: 90%; max-width: 1050px; display: flex; gap: 60px; max-height: 85vh; 
            overflow-y: auto; padding: 60px; background: rgba(255, 255, 255, 0.02); 
            border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.12);
        }

        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); background: rgba(255,255,255,0.02); border-top: 1px solid #222; }
        .cal-day { height: 130px; border-right: 1px solid #222; border-bottom: 1px solid #222; padding: 10px; font-size: 0.8rem; }
        .cal-event { background: var(--ios-accent); color: white; padding: 4px; border-radius: 4px; font-size: 0.65rem; margin-top: 4px; overflow: hidden; }

        /* 모바일 최적화 수정본 */
        @media (max-width: 768px) {
            nav { padding: 20px 15px; flex-direction: column; gap: 15px; background: rgba(10, 10, 10, 0.9); mix-blend-mode: normal; }
            nav ul { gap: 15px; }
            .scroller { padding: 160px 20px 60px 20px; }
            #write-title { font-size: 14vw; margin-bottom: 30px; } /* 모바일용 타이틀 크기 */
            .archive-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .imessage-container { padding: 25px; border-radius: 25px; width: 100%; }
            .modal-content { flex-direction: column; padding: 30px; gap: 30px; margin-top: 40px; }
            #m-img { width: 100% !important; max-width: 250px; margin: 0 auto; }
            #m-title { font-size: 2.2rem !important; }
            .cal-day { height: 80px; padding: 5px; font-size: 0.7rem; }
            #cal-month-title { font-size: 2.5rem !important; }
        }
    </style>
</head>
<body>

    <div class="bg-text" id="bgText">ARCHIVE</div>

    <nav>
        <div class="logo" onclick="showSection('main')">ARCHIVE.</div>
        <ul>
            <li onclick="showSection('main')" id="nav-main" class="active">Write</li>
            <li onclick="showSection('dvd')" id="nav-dvd">DVD Store</li>
            <li onclick="showSection('book')" id="nav-book">Library</li>
            <li onclick="showSection('cal')" id="nav-cal">Calendar</li>
            <li onclick="showSection('stats')" id="nav-stats">Count</li>
        </ul>
    </nav>

    <section id="main" class="scroller active">
        <h1 id="write-title">MEMORIES<br>ONLY_</h1>
        <div class="imessage-container">
            <div style="display: flex; background: rgba(0,0,0,0.3); border-radius: 14px; padding: 5px; margin-bottom: 35px;">
                <div class="cat-btn active" id="btn-movie" onclick="setCategory('movie')" style="flex:1; padding:14px; text-align:center; cursor:pointer; border-radius:11px; font-size:0.8rem; font-weight:700;">Movie</div>
                <div class="cat-btn" id="btn-book" onclick="setCategory('book')" style="flex:1; padding:14px; text-align:center; cursor:pointer; border-radius:11px; font-size:0.8rem; font-weight:700;">Book</div>
            </div>
            <style>.cat-btn.active{background:var(--ios-accent);color:#fff;}.cat-btn{color:#555;transition:0.3s;}</style>
            
            <div class="ios-label">Title</div><input type="text" id="in-title" placeholder="Entry title">
            <div style="display:flex; gap:10px; margin: 20px 0;">
                <div style="flex: 2;"><div class="ios-label" id="label-author">Director</div><input type="text" id="in-author"></div>
                <div style="flex: 1;" id="year-field"><div class="ios-label">Year</div><input type="text" id="in-year" placeholder="2026"></div>
            </div>
            <div class="ios-label">Image URL</div><input type="text" id="in-img" style="margin-bottom:20px;">
            <div class="ios-label">Review</div><textarea id="in-review" rows="4" style="margin-bottom:20px;"></textarea>
            <div class="ios-label">Value</div><input type="text" id="in-price" placeholder="₩ 0">
            <button class="save-btn" onclick="saveRecord()">SAVE ARCHIVE</button>
        </div>
    </section>

    <section id="dvd" class="scroller"><div class="archive-grid" id="dvd-grid"></div></section>
    <section id="book" class="scroller"><div class="archive-grid" id="book-grid"></div></section>
    <section id="cal" class="scroller">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:40px;">
            <h1 id="cal-month-title" style="font-family:'Syne'; font-size:4.5rem; margin:0; line-height:1; font-weight:800; letter-spacing:-0.03em;">MONTH</h1>
            <div style="display:flex; gap:10px;">
                <button onclick="changeMonth(-1)" style="background:none; color:white; border:1px solid #333; cursor:pointer; padding:10px 20px; border-radius:10px; font-size:0.7rem;">PREV</button>
                <button onclick="changeMonth(1)" style="background:none; color:white; border:1px solid #333; cursor:pointer; padding:10px 20px; border-radius:10px; font-size:0.7rem;">NEXT</button>
            </div>
        </div>
        <div id="calendar"></div>
        <div id="event-form" style="display:none; margin-top:30px; background:rgba(255,255,255,0.03); padding:30px; border-radius:25px; border:1px solid #222;">
            <input type="text" id="ev-text" placeholder="Event Name" style="margin-bottom:15px;">
            <button class="save-btn" onclick="saveEvent()">ADD</button>
        </div>
    </section>

    <section id="stats" class="scroller">
        <div style="font-size: 8vw; font-family: 'Syne'; font-weight: 800; line-height: 0.85; letter-spacing: -0.05em;">
            TOTAL <span style="color:var(--primary)" id="stat-movie">0</span> MOVIES<br>
            COLLECTED <span style="color:var(--ios-accent)" id="stat-book">0</span> BOOKS.
        </div>
    </section>

    <div class="modal" id="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img src="" id="m-img" style="width: 340px; border-radius: 15px; object-fit: cover; align-self: flex-start;">
            <div style="flex: 1;">
                <div id="m-meta" style="color:var(--primary); font-size: 0.8rem; font-weight: 800; letter-spacing: 0.15em;">META</div>
                <h1 id="m-title" style="font-family:'Syne'; font-size: 3.5rem; margin: 10px 0; line-height: 0.95; font-weight:800;">TITLE</h1>
                <p id="m-review" style="font-size: 1rem; color: #ccc; line-height: 1.6; margin-bottom: 30px; white-space: pre-wrap;"></p>
                <div id="m-price" style="font-size: 1.2rem; font-weight: 800;">PRICE</div>
                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button onclick="editRecord()" style="background:#fff; color:#000; padding:12px 25px; border-radius:10px; border:none; font-weight:800;">EDIT</button>
                    <button onclick="deleteRecord()" style="background:none; color:#ff453a; border:1px solid #ff453a; padding:12px 25px; border-radius:10px;">DELETE</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA_tiN-nm1ztfHWTSGcmf7pZawSNy8ahM0",
          authDomain: "watcha-1d01a.firebaseapp.com",
          projectId: "watcha-1d01a",
          storageBucket: "watcha-1d01a.firebasestorage.app",
          messagingSenderId: "293815354232",
          appId: "1:293815354232:web:3f0ceaba4d2f13c58a7e8d",
          measurementId: "G-3BDT1GT0XB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const archiveCol = collection(db, "archives");

        window.currentCategory = 'movie';
        window.records = [];
        window.events = JSON.parse(localStorage.getItem('events_v5')) || [];
        window.currentCalDate = new Date();
        window.selectedId = null;
        window.editModeId = null;

        const q = query(archiveCol, orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            window.records = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRecords();
        });

        window.setCategory = (cat) => {
            window.currentCategory = cat;
            document.getElementById('btn-movie').classList.toggle('active', cat === 'movie');
            document.getElementById('btn-book').classList.toggle('active', cat === 'book');
            document.getElementById('label-author').innerText = cat === 'movie' ? 'Director' : 'Author';
            document.getElementById('year-field').style.display = cat === 'book' ? 'none' : 'block';
        };

        window.saveRecord = async () => {
            const title = document.getElementById('in-title').value;
            if(!title) return;
            const data = {
                category: window.currentCategory,
                title,
                author: document.getElementById('in-author').value,
                year: window.currentCategory === 'movie' ? document.getElementById('in-year').value : '',
                img: document.getElementById('in-img').value,
                review: document.getElementById('in-review').value,
                price: document.getElementById('in-price').value,
                timestamp: Date.now(),
                comments: window.editModeId ? (window.records.find(r=>r.id===window.editModeId).comments || []) : []
            };
            if(window.editModeId) {
                await updateDoc(doc(db, "archives", window.editModeId), data);
                window.editModeId = null;
            } else {
                await addDoc(archiveCol, data);
            }
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
            document.getElementById('write-title').innerHTML = "MEMORIES<br>ONLY_";
        };

        window.renderRecords = () => {
            const dg = document.getElementById('dvd-grid'), bg = document.getElementById('book-grid');
            if(!dg || !bg) return;
            dg.innerHTML = ''; bg.innerHTML = '';
            window.records.forEach(r => {
                const item = document.createElement('div');
                item.className = 'archive-item';
                item.onclick = () => openModal(r);
                item.innerHTML = `<div class="img-wrap"><img src="${r.img}"></div><div class="item-title">${r.title}</div>`;
                if(r.category === 'movie') dg.appendChild(item); else bg.appendChild(item);
            });
            updateStats();
        };

        window.openModal = (r) => {
            window.selectedId = r.id;
            document.getElementById('m-img').src = r.img;
            document.getElementById('m-title').innerText = r.title;
            document.getElementById('m-meta').innerText = r.category === 'movie' ? `${r.author.toUpperCase()} / ${r.year}` : r.author.toUpperCase();
            document.getElementById('m-review').innerText = r.review;
            document.getElementById('m-price').innerText = '₩ ' + (r.price || '0');
            document.getElementById('modal').classList.add('active');
        };

        window.closeModal = () => document.getElementById('modal').classList.remove('active');

        window.deleteRecord = async () => {
            if(confirm("정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "archives", window.selectedId));
                closeModal();
            }
        };

        window.editRecord = () => {
            const r = window.records.find(x => x.id === window.selectedId);
            closeModal(); showSection('main');
            window.editModeId = r.id;
            document.getElementById('in-title').value = r.title;
            document.getElementById('in-author').value = r.author;
            document.getElementById('in-year').value = r.year;
            document.getElementById('in-img').value = r.img;
            document.getElementById('in-review').value = r.review;
            document.getElementById('in-price').value = r.price;
            document.getElementById('write-title').innerHTML = "EDITING<br>ARCHIVE_";
        };

        window.showSection = (id) => {
            document.querySelectorAll('.scroller').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav li').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
            if(id === 'cal') renderCalendar();
        };

        window.updateStats = () => {
            document.getElementById('stat-movie').innerText = window.records.filter(r=>r.category==='movie').length;
            document.getElementById('stat-book').innerText = window.records.filter(r=>r.category==='book').length;
        };

        // 캘린더 간단 로직
        window.renderCalendar = () => {
            const cal = document.getElementById('calendar'); cal.innerHTML = '';
            const y = window.currentCalDate.getFullYear(), m = window.currentCalDate.getMonth();
            document.getElementById('cal-month-title').innerText = `${y}.${m+1}`;
            const days = new Date(y, m+1, 0).getDate();
            for(let d=1; d<=days; d++) {
                const day = document.createElement('div'); day.className = 'cal-day'; day.innerText = d;
                cal.appendChild(day);
            }
        };
        window.changeMonth = (v) => { window.currentCalDate.setMonth(window.currentCalDate.getMonth()+v); renderCalendar(); };
    </script>
</body>
</html>